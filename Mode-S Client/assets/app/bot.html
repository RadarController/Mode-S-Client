<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bot Commands</title>
  <link rel="stylesheet" href="/app/app.css" />
  <style>
    /* Minimal page-specific styling (the rest comes from app.css) */
    .statusMsg{font-size:12px;color:var(--muted)}
    .statusMsg.good{color:#9f9}
    .statusMsg.bad{color:#f99}
    .input.small{max-width:130px}
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="brand__mark">
          <img src="/assets/icons/RClogo.svg" alt="RadarController" style="width:100%;height:100%;display:block;opacity:0.8;border-radius:inherit;" />
        </div>
        <div class="brand__text">
          <div class="brand__title">RadarController</div>
          <div class="brand__subtitle">Mode‑S Client</div>
        </div>
      </div>

      <div class="topbar__metrics" style="justify-content:flex-start">
        <div class="pill"><span class="pill__k">Page</span><span class="pill__v">Bot Commands</span></div>
      </div>

      <div class="topbar__actions">
        <button class="btn btn--ghost" id="btnBack">Back</button>
        <button class="btn btn--ghost" id="btnReload">Reload</button>
        <button class="btn btn--ghost" id="btnAdd">Add command</button>
        <button class="btn btn--primary" id="btnSave">Save</button>
      </div>
    </header>

    <main class="grid grid--single">
      <section class="card">
        <div class="card__head">
          <div class="card__title">Bot Commands</div>
          <div class="card__hint">
            Controls the overlay-only chatbot (responses are injected into <span class="mono">/api/chat</span> for now). Commands are matched without the leading <span class="mono">!</span> and are case-insensitive.
            Placeholders: <span class="mono">{user}</span>, <span class="mono">{platform}</span>.
          </div>
        </div>

        <div style="padding:12px">
          <div class="toolbar" style="margin-bottom:10px">
            <span id="status" class="statusMsg toolbar__spacer"></span>
          </div>

          <table id="tbl" class="table">
    <thead>
      <tr>
        <th style="width:160px;">Command</th>
        <th>Response</th>
        <th style="width:120px;">Cooldown (ms)</th>
        <th style="width:90px;">Enabled</th>
        <th style="width:70px;"></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  const statusEl = document.getElementById('status');
  const tbody = document.querySelector('#tbl tbody');

  function setStatus(text, ok=true) {
    statusEl.textContent = text;
    statusEl.classList.toggle('good', ok);
    statusEl.classList.toggle('bad', !ok);
  }

  function rowTemplate(cmd={command:'', response:'', cooldown_ms:3000, enabled:true}) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="input" type="text" placeholder="help" value="${escapeHtml(cmd.command||'')}"></td>
      <td><textarea class="input textarea" placeholder="Your response">${escapeHtml(cmd.response||'')}</textarea></td>
      <td><input class="input small" type="number" min="0" max="600000" value="${Number.isFinite(cmd.cooldown_ms)?cmd.cooldown_ms:3000}"></td>
      <td style="text-align:center;"><input type="checkbox" ${cmd.enabled? 'checked':''}></td>
      <td><button class="btn btn--danger btnDel" type="button">Delete</button></td>
    `;
    tr.querySelector('.btnDel').addEventListener('click', () => tr.remove());
    return tr;
  }

  function escapeHtml(s) {
    return (s+'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
  }

  function collect() {
    const rows = [...tbody.querySelectorAll('tr')];
    const out = [];
    for (const r of rows) {
      const command = r.querySelector('td:nth-child(1) input').value.trim();
      const response = r.querySelector('td:nth-child(2) textarea').value;
      const cooldown_ms = parseInt(r.querySelector('td:nth-child(3) input').value||'3000', 10);
      const enabled = r.querySelector('td:nth-child(4) input[type=checkbox]').checked;
      if (!command) continue;
      out.push({ command, response, cooldown_ms: isFinite(cooldown_ms)?cooldown_ms:3000, enabled });
    }
    return out;
  }

  async function load() {
    setStatus('Loading...');
    tbody.innerHTML = '';
    try {
      const res = await fetch('/api/bot/commands', { cache: 'no-store' });
      const j = await res.json();
      const cmds = (j && j.commands) ? j.commands : [];
      for (const c of cmds) tbody.appendChild(rowTemplate(c));
      if (!cmds.length) tbody.appendChild(rowTemplate());
      setStatus('Loaded', true);
    } catch (e) {
      setStatus('Load failed: ' + e, false);
    }
  }

  async function save() {
    setStatus('Saving...');
    const commands = collect();
    try {
      const res = await fetch('/api/bot/commands', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ commands })
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      await load();
      setStatus('Saved', true);
    } catch (e) {
      setStatus('Save failed: ' + e, false);
    }
  }

  document.getElementById('btnReload').addEventListener('click', load);
  document.getElementById('btnAdd').addEventListener('click', () => tbody.appendChild(rowTemplate()));
  document.getElementById('btnSave').addEventListener('click', save);
  document.getElementById('btnBack').addEventListener('click', () => {
    window.location.href = '/app/index.html';
  });

  load();
</script>
          </div>
      </section>
    </main>

    <footer class="footer">
      <div class="footer__left">Local UI at <span class="mono">/app</span> (served by the built‑in HTTP server).</div>
      <div class="footer__right"><span class="mono">Bot config</span></div>
    </footer>
  </div>
</body>
</html>
