<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EuroScope Traffic (Cycle)</title>
  <style>
    /* Match chat.html base first */
    :root{
      --font: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      --overlay-h: 200px;  /* fixed OBS-friendly height */

      /* Borrowed vibe from alerts.css */
      --edge: rgba(255, 255, 255, 0.08);
      --ink: rgba(230, 237, 243, 0.95);
      --muted: rgba(230, 237, 243, 0.65);
      --bg0: rgba(11, 15, 20, 0.78);
      --bg1: rgba(11, 15, 20, 0.62);
    }

    html, body{
      margin:0;
      padding:0;
      background: transparent;
      overflow: hidden;
      height: var(--overlay-h);
    }

    body{
      font-family: var(--font);
      color: #fff;
    }

    .wrap{
      width: 520px;
      height: var(--overlay-h);
      box-sizing: border-box;
      color: var(--ink);
      overflow: hidden;
      border-radius: 18px;
      background: linear-gradient(180deg, var(--bg0), var(--bg1));
      border: 1px solid var(--edge);
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .top{
      padding: 10px 12px;
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid var(--edge);
    }
    .title{
      font-weight: 800;
      letter-spacing: .18em;
      font-size: 12px;
      text-transform: uppercase;
    }

    .body{
      padding: 10px 12px 12px 12px;
      height: calc(var(--overlay-h) - 44px);
      box-sizing: border-box;
    }

    .slideTitle{
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .14em;
      margin-bottom: 8px;
    }

    .big{
      font-size: 26px;
      font-weight: 800;
      letter-spacing: .2px;
      line-height: 1.05;
    }

    ul{
      margin: 0;
      padding: 0 0 0 16px;
      columns: 2;
      column-gap: 18px;
      max-height: 76px; /* keep fixed height */
      overflow: hidden;
    }
    li{
      margin: 0 0 4px 0;
      padding: 0;
      font-size: 14px;
      break-inside: avoid;
    }

    .row{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 12px;
      margin: 6px 0;
      font-size: 14px;
    }
    .row .k{ color: var(--muted); }
    .row .v{ font-weight: 650; }
    .pill{
      display:inline-block;
      padding: 2px 8px;
      border: 1px solid rgba(131,174,252,0.28);
      border-radius: 999px;
      font-size: 12px;
      color: rgba(131,174,252,0.95);
      background: rgba(131,174,252,0.08);
    }

    .fade{
      opacity: 0;
      transform: translateY(4px);
      transition: opacity .25s ease, transform .25s ease;
    }
    .fade.on{
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">EuroScope Traffic</div>
</div>

    <div class="body">
      <div class="slideTitle" id="slideTitle">—</div>
      <div id="slide" class="fade">—</div>
    </div>
  </div>

<script>
(() => {
  const ENDPOINT = "/api/euroscope/traffic";
  const POLL_MS = 900;      // frequent but cheap (we diff before rendering)
  const SLIDE_MS = 6000;

  const slideTitleEl = document.getElementById("slideTitle");
  const slideA = document.getElementById("slideA");
  const slideB = document.getElementById("slideB");

  let front = slideA;
  let back  = slideB;

  let latest = null;
  let lastTs = 0;
  let slideIx = 0;

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function swapSlide(html){
    // Cross-fade: never blank the front layer (prevents OBS flicker).
    back.innerHTML = html;
    back.classList.remove("hide");
    back.classList.add("show");
    front.classList.remove("show");
    front.classList.add("hide");

    // Swap references after fade completes
    const oldFront = front;
    front = back;
    back = oldFront;

    // Make sure the now-back layer is fully hidden after transition and won't capture focus
    setTimeout(() => {
      back.classList.remove("show");
      back.classList.add("hide");
    }, 260);
  }

  function setTitle(t){ slideTitleEl.textContent = t; }

  function renderOnFreq(d){
    setTitle("On frequency");
    const list = (d && Array.isArray(d.assumed_list)) ? d.assumed_list : [];
    if (!list.length){
      swapSlide(
        `<div class="big">0</div>
         <div class="row"><span class="k">Assumed now</span><span class="pill">No aircraft assumed</span></div>`
      );
      return;
    }
    const max = 24;
    const items = list.slice(0, max).map(cs => `<li>${escapeHtml(cs)}</li>`).join("");
    const more = list.length > max
      ? `<div class="row"><span class="k">More</span><span class="v">+${list.length-max}</span></div>`
      : "";
    swapSlide(
      `<div class="row"><span class="k">Assumed now</span><span class="v">${list.length}</span></div>
       <ul class="list">${items}</ul>
       ${more}`
    );
  }

  function formatMiles(nm){
    if (nm == null || !isFinite(nm)) return "—";
    return (nm < 10 ? nm.toFixed(1) : nm.toFixed(0)) + "nm";
  }

  function renderNextArrival(d){
    setTitle("Next arrival");
    const a = d && d.next_arrival;
    if (!a){
      swapSlide(`<div class="big">—</div><div class="row"><span class="pill">No inbound detected</span></div>`);
      return;
    }
    swapSlide(
      `<div class="big">${escapeHtml(a.callsign || "—")}</div>
       <div class="row"><span class="k">Runway</span><span class="v">${escapeHtml(a.runway || "—")}</span></div>
       <div class="row"><span class="k">Distance</span><span class="v">${formatMiles(a.dist_nm)}</span></div>
       <div class="row"><span class="k">Alt</span><span class="v">${(a.alt_ft!=null && isFinite(a.alt_ft)) ? Math.round(a.alt_ft) + "ft" : "—"}</span></div>`
    );
  }

  function renderNextDeparture(d){
    setTitle("Next departure");
    const a = d && d.next_departure;
    if (!a){
      swapSlide(`<div class="big">—</div><div class="row"><span class="pill">No DEPA detected</span></div>`);
      return;
    }
    swapSlide(
      `<div class="big">${escapeHtml(a.callsign || "—")}</div>
       <div class="row"><span class="k">Runway</span><span class="v">${escapeHtml(a.runway || "—")}</span></div>
       <div class="row"><span class="k">Distance</span><span class="v">${formatMiles(a.dist_nm)}</span></div>`
    );
  }

  function renderSlide(){
    const d = latest || {};
    // Cycle slides: On frequency -> Next arrival -> Next departure
    const fns = [renderOnFreq, renderNextArrival, renderNextDeparture];
    fns[slideIx % fns.length](d);
    slideIx = (slideIx + 1) % fns.length;
  }

  async function poll(){
    try{
      const r = await fetch(ENDPOINT, { cache: "no-store" });
      if (!r.ok) return;
      const d = await r.json();
      // Only accept updates when ts_ms changes (prevents unnecessary DOM churn)
      const ts = (d && typeof d.ts_ms === "number") ? d.ts_ms : 0;
      if (ts && ts !== lastTs){
        lastTs = ts;
        latest = d;
      }
    }catch(_e){}
  }

  // Start
  poll();
  renderSlide();
  setInterval(poll, POLL_MS);
  setInterval(() => requestAnimationFrame(renderSlide), SLIDE_MS);
})();

</script>
</body>
</html>
